# SQL

| workflow | node | param_path | sql_excerpt | tables_guess |
| --- | --- | --- | --- | --- |
| 1. Atendente.V2.0 | historico | $.parameters.query | WITH inp AS (   SELECT regexp_replace($1::text, '\D', '', 'g') AS d ), cand AS (   -- d (como veio), d sem 55 e d com 55   SELECT d                            AS k FROM inp   UNION ALL SELECT CASE WHEN left(d,2)='55' THEN substring(d from 3) ELSE d END FROM inp   UNION ALL SELECT CASE WHEN left(d,2)='55' THEN d ELSE '55'\|\|d END FROM inp ) SELECT * FROM public.view_client_snapshot WHERE regexp_repl... | ALL, AS, CASE, D, DESC, ELSE, END, IN, LAST, NULLS, THEN, UNION, WHEN, WITH, cand, com, como, d, e, g, inp, k, last_order_at, phone, public, regexp_replace, sem, substring, text, veio, view_client_sna |
| 1. Atendente.V2.0 | controle atendimentos | $.parameters.query | INSERT INTO public.active_sessions AS s   (session_id, last_message, last_message_type, status) VALUES   (     '{{ $("Info").first().json.telefone \|\| $json.session_id }}',   -- fone (sem +)     '{{ $("Mensagem encavalada?").all().map(i => i.json.mensagem).join("\\n") }}',  -- texto puro     'human',     'active'   ) ON CONFLICT (session_id) WHERE (status = 'active') DO UPDATE    SET last_message  ... | AS, CONFLICT, DO, EXCLUDED, Info, Mensagem, NULL, active, active_sessions, all, encavalada, first, followup_sent_at, fone, human, humano, i, json, last_message, last_message_type, map, mensagem, n, no |
| 1. Atendente.V2.0 | atualiza atendimento | $.parameters.query | INSERT INTO public.active_sessions AS s   (session_id, last_message, last_message_type, status) VALUES   (     '{{ $("Info").first().json.telefone \|\| $json.session_id }}',   -- fone (sem +)     '{{ $json.output \|\| $json.text \|\| $json.reply }}',  -- texto do agent     'ai',     'active'   ) ON CONFLICT (session_id) WHERE (status = 'active') DO UPDATE    SET last_message      = EXCLUDED.last_message... | AS, CONFLICT, DO, EXCLUDED, Info, active, active_sessions, agent, ai, do, first, fone, json, last_message, last_message_type, now, output, public, reply, s, sem, session_id, status, telefone, text, te |
| 1. Atendente.V2.0 | controle atendimentos1 | $.parameters.query | INSERT INTO public.active_sessions AS s   (session_id, last_message, last_message_type, status) VALUES   (     '{{ $('Info').item.json.telefone \|\| $json.session_id }}',   -- fone (sem +)     '{{ $json.text }}',                       -- texto puro     'human',     'active'   ) ON CONFLICT (session_id) WHERE (status = 'active') DO UPDATE    SET last_message      = EXCLUDED.last_message,        last_... | AS, CONFLICT, DO, EXCLUDED, Info, NULL, active, active_sessions, followup_sent_at, fone, human, humano, item, json, last_message, last_message_type, now, o, public, puro, quando, reseta, responde, s,  |
